<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Trade Intelligence - AI Trade Management</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          fontFamily: {
            sans: ['Plus Jakarta Sans', 'sans-serif']
          }
        }
      }
    }
  </script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="./config.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
  
  <style>
    body {
      font-family: 'Plus Jakarta Sans', sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      margin: 0;
      padding: 0;
    }

    .custom-scrollbar::-webkit-scrollbar {
      width: 4px;
    }

    .custom-scrollbar::-webkit-scrollbar-track {
      background: rgba(255, 255, 255, 0.1);
      border-radius: 2px;
    }

    .custom-scrollbar::-webkit-scrollbar-thumb {
      background: rgba(255, 255, 255, 0.3);
      border-radius: 2px;
    }

    .custom-scrollbar::-webkit-scrollbar-thumb:hover {
      background: rgba(255, 255, 255, 0.5);
    }

    @keyframes pulse {
      0% { transform: scale(0.95); box-shadow: 0 0 0 0 rgba(16, 185, 129, 0.7); }
      70% { transform: scale(1); box-shadow: 0 0 0 10px rgba(16, 185, 129, 0); }
      100% { transform: scale(0.95); box-shadow: 0 0 0 0 rgba(16, 185, 129, 0); }
    }

    @keyframes slideInRight {
      from { transform: translateX(100%); opacity: 0; }
      to { transform: translateX(0); opacity: 1; }
    }

    @keyframes slideOutRight {
      from { transform: translateX(0); opacity: 1; }
      to { transform: translateX(100%); opacity: 0; }
    }

    .toast-enter {
      animation: slideInRight 0.3s ease-out;
    }

    .toast-exit {
      animation: slideOutRight 0.3s ease-in;
    }

    .error-shake {
      animation: shake 0.5s ease-in-out;
    }

    @keyframes shake {
      0%, 100% { transform: translateX(0); }
      25% { transform: translateX(-5px); }
      75% { transform: translateX(5px); }
    }
  </style>
</head>
<body>
  <!-- Navigation Header -->
  <nav class="bg-white/10 backdrop-blur-md border-b border-white/20 sticky top-0 z-50">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
      <div class="flex justify-between items-center py-4">
        <div class="flex items-center gap-3">
          <div class="w-10 h-10 bg-blue-600 rounded-xl flex items-center justify-center shadow-lg">
            <i class="fas fa-ship text-white text-lg"></i>
          </div>
          <div>
            <h1 class="text-lg font-bold text-white">Trade Intelligence</h1>
            <p class="text-sm text-white">AI Trade Intelligence</p>
          </div>
        </div>
        
        <div class="hidden md:flex items-center gap-6">
          <div class="text-right">
            <p class="font-semibold text-white" id="lastUpdated"></p>
          </div>
          <div class="flex items-center gap-4">
            <div class="flex items-center gap-2" id="connectionStatus">
              <div class="w-2 h-2 bg-green-400 rounded-full animate-pulse"></div>
              <span class="text-sm text-green-600 font-medium text-white">Online</span>
            </div>
            <button onclick="logout()" class="text-sm text-white/80 hover:text-white px-3 py-1 rounded-lg hover:bg-white/10 transition-colors">
              <i class="fas fa-sign-out-alt mr-1"></i>
              Logout
            </button>
          </div>
        </div>
      </div>
    </div>
  </nav>
  
  <!-- Connection Status Banner (hidden by default) -->
  <div id="connectionBanner" class="hidden bg-red-500 text-white text-center py-2 px-4">
    <div class="flex items-center justify-center gap-2">
      <i class="fas fa-exclamation-triangle"></i>
      <span id="connectionMessage">Connection lost. Attempting to reconnect...</span>
    </div>
  </div>
  
  <!-- Main Content -->
  <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-6 min-h-screen">
    
    <!-- Header Section -->
    <div class="text-center mb-8">
      <h1 class="text-3xl lg:text-4xl font-bold text-white mb-4">AI Trade Intelligence</h1>
    </div>

    <!-- Enhanced Search Command Center -->
    <div class="bg-white rounded-2xl p-6 mb-8 shadow-lg border border-gray-200">
      <div class="flex items-center gap-3 mb-4">
        <div class="w-10 h-10 bg-blue-600 rounded-lg flex items-center justify-center">
          <i class="fas fa-brain text-white"></i>
        </div>
        <h2 class="text-xl font-bold text-gray-800">Trade AI Command</h2>
      </div>
      
      <!-- Main Search Bar -->
      <div class="flex flex-col sm:flex-row gap-3 mb-4">
        <div class="flex-1">
          <input 
            id="searchInput" 
            type="text" 
            placeholder="find buyer from uk" 
            class="w-full px-3 py-2.5 sm:px-4 sm:py-3 rounded-xl border border-gray-300 bg-white text-gray-800 placeholder-gray-500 focus:border-blue-400 focus:ring-2 focus:ring-blue-400/50 outline-none transition-all text-sm sm:text-base" 
          />
        </div>
        <div class="flex gap-2 sm:gap-3">
          <button 
            id="searchButton"
            onclick="performSearch()" 
            class="flex-1 sm:w-auto bg-blue-600 hover:bg-blue-700 text-white px-3 py-2.5 sm:px-6 sm:py-3 rounded-xl font-semibold transition-all flex items-center justify-center gap-1 sm:gap-2 min-w-[90px] sm:min-w-[120px] text-sm sm:text-base"
          >
            <i id="searchIcon" class="fas fa-search text-xs sm:text-sm"></i>
            <span id="searchText">Search</span>
          </button>
          <button 
            onclick="openCreateModal()" 
            class="flex-shrink-0 bg-green-600 hover:bg-green-700 text-white px-3 py-2.5 sm:px-4 sm:py-2.5 rounded-xl font-medium transition-all flex items-center justify-center gap-1 text-sm sm:text-base"
          >
            <i class="fas fa-plus text-xs sm:text-sm"></i>
            <span class="hidden xs:inline">Create</span>
          </button>
        </div>
      </div>
      
      <!-- Quick Actions -->
      <div class="mb-4">
        <div class="flex flex-wrap gap-2">
          <span class="text-xs sm:text-sm text-gray-500 mr-1 sm:mr-2 mb-1">Quick actions:</span>
          <button onclick="quickSearch('all buyers')" class="text-xs sm:text-sm bg-blue-100 hover:bg-blue-200 text-blue-700 px-2 py-1 sm:px-3 sm:py-1.5 rounded-full transition-colors min-h-[28px] sm:min-h-[32px]">
            All Buyers
          </button>
          <button onclick="quickSearch('all sellers')" class="text-xs sm:text-sm bg-green-100 hover:bg-green-200 text-green-700 px-2 py-1 sm:px-3 sm:py-1.5 rounded-full transition-colors min-h-[28px] sm:min-h-[32px]">
            All Sellers
          </button>
          <button onclick="quickSearch('gulfood data')" class="text-xs sm:text-sm bg-orange-100 hover:bg-orange-200 text-orange-700 px-2 py-1 sm:px-3 sm:py-1.5 rounded-full transition-colors min-h-[28px] sm:min-h-[32px]">
            Gulfood Data
          </button>
          <button onclick="clearResults()" class="text-xs sm:text-sm bg-gray-100 hover:bg-gray-200 text-gray-700 px-2 py-1 sm:px-3 sm:py-1.5 rounded-full transition-colors min-h-[28px] sm:min-h-[32px]">
            Clear Results
          </button>
        </div>
      </div>

      <!-- Advanced Search Panel -->
      <div class="border-t border-gray-200 pt-4">
        <div class="flex items-center gap-2 mb-4">
          <i class="fas fa-sliders-h text-gray-600"></i>
          <h3 class="text-sm font-semibold text-gray-700">Product Mapping</h3>
          <button onclick="toggleAdvancedPanel()" class="sm:hidden ml-auto p-1 text-gray-500 hover:text-gray-700">
            <i id="advancedToggleIcon" class="fas fa-chevron-right text-xs"></i>
          </button>
        </div>
        
        <div id="advancedContent" class="hidden sm:grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-3 sm:gap-4 mb-4">
          <!-- Search Type -->
          <div>
            <label class="block text-xs sm:text-sm font-medium text-gray-700 mb-1 sm:mb-2">Search Type</label>
            <select id="searchType" class="w-full px-2 py-2 sm:px-3 sm:py-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 text-sm sm:text-base">
              <option value="all">All Companies</option>
              <option value="buyer">Buyers Only</option>
              <option value="seller">Sellers Only</option>
            </select>
          </div>
          
          <!-- Product/Brand -->
          <div>
            <label class="block text-xs sm:text-sm font-medium text-gray-700 mb-1 sm:mb-2">Product/Brand</label>
            <input 
              id="productSearch" 
              type="text" 
              placeholder="FMCG"
              class="w-full px-2 py-2 sm:px-3 sm:py-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 text-sm sm:text-base"
            />
          </div>
          
          <!-- Country -->
          <div class="relative sm:col-span-2 lg:col-span-1">
            <label class="block text-xs sm:text-sm font-medium text-gray-700 mb-1 sm:mb-2">Country</label>
            <input 
              id="countryFilter" 
              type="text" 
              placeholder="Type country name..."
              class="w-full px-2 py-2 sm:px-3 sm:py-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 text-sm sm:text-base"
              oninput="showCountrySuggestions()"
              onfocus="showCountrySuggestions()"
              onblur="hideCountrySuggestions()"
            />
            <div id="countrySuggestions" class="absolute z-10 w-full bg-white border border-gray-300 rounded-lg mt-1 max-h-48 overflow-y-auto hidden shadow-lg">
              <!-- Country suggestions will be populated here -->
            </div>
          </div>
        </div>
        
        <!-- Advanced Search Actions -->
        <div id="advancedActions" class="hidden sm:flex gap-2 sm:gap-3">
          <button 
            onclick="performProductMatching()" 
            class="flex-auto bg-purple-600 hover:bg-purple-700 text-white px-4 py-2 sm:px-6 sm:py-2.5 rounded-lg font-semibold transition-all flex items-center justify-center gap-2 text-sm sm:text-base"
          >
            <i class="fas fa-link text-xs sm:text-sm"></i>
            <span>Product Mapping</span>
          </button>
          <button 
            onclick="resetAdvancedFilters()" 
            class="flex-shrink-0 bg-gray-500 hover:bg-gray-600 text-white px-3 py-2 sm:px-4 sm:py-2.5 rounded-lg font-medium transition-all flex items-center justify-center gap-1 text-sm sm:text-base"
          >
            <i class="fas fa-undo text-xs sm:text-sm"></i>
            <span class="hidden xs:inline">Reset</span>
          </button>
        </div>
      </div>
    </div>

    <!-- Product Matching Results Section -->
    <div id="productMatchingResults" class="hidden bg-white rounded-2xl p-6 shadow-lg border border-gray-200 mb-8">
      <div class="flex items-center gap-3 mb-6">
        <div class="w-10 h-10 bg-purple-100 rounded-lg flex items-center justify-center">
          <i class="fas fa-link text-purple-600"></i>
        </div>
        <div class="flex-1">
          <h3 class="text-base sm:text-lg font-bold text-gray-800">Product Mapping Results</h3>
          <p class="text-sm sm:text-base text-gray-600" id="productMatchingSubtitle">Find buyers and sellers for your products</p>
        </div>
        <button onclick="closeProductMapping()" class="text-gray-400 hover:text-gray-600 p-2">
          <i class="fas fa-times"></i>
        </button>
      </div>
      
      <!-- Product Info Header -->
      <div class="bg-gradient-to-r from-purple-50 to-blue-50 rounded-lg p-4 mb-6" id="productInfoHeader">
        <!-- Product details will be populated here -->
      </div>
      
      <!-- Buyers and Sellers Grid -->
      <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
        <!-- Buyers Section -->
        <div class="bg-blue-50 rounded-lg p-4">
          <div class="flex items-center gap-2 mb-4">
            <i class="fas fa-shopping-cart text-blue-600"></i>
            <h4 class="text-base sm:text-lg font-semibold text-blue-800" id="buyersTitle">Buyers (0)</h4>
          </div>
          <div class="space-y-0 max-h-96 overflow-y-auto custom-scrollbar" id="buyersList">
            <!-- Buyers will be populated here -->
          </div>
        </div>
        
        <!-- Sellers Section -->
        <div class="bg-green-50 rounded-lg p-4">
          <div class="flex items-center gap-2 mb-4">
            <i class="fas fa-store text-green-600"></i>
            <h4 class="text-base sm:text-lg font-semibold text-green-800" id="sellersTitle">Sellers (0)</h4>
          </div>
          <div class="space-y-0 max-h-96 overflow-y-auto custom-scrollbar" id="sellersList">
            <!-- Sellers will be populated here -->
          </div>
        </div>
      </div>
    </div>
    <!-- Results Section -->
    <div class="mb-8">
      <!-- Results will show here -->
      <div id="resultsSection" class="hidden">
        <div class="bg-white rounded-2xl p-4 shadow-lg border border-gray-200">
          <div class="mb-4">
            <div class="flex items-center justify-between mb-2">
              <h3 class="text-lg font-bold text-gray-800">Results</h3>
              <div class="flex items-center gap-2 flex-shrink-0">
                <select id="sortBy" onchange="sortResults()" class="text-xs border border-gray-300 rounded-lg px-2 py-1 focus:border-blue-500">
                  <option value="default">Default</option>
                  <option value="name">By Name</option>
                  <option value="country">By Country</option>
                  <option value="products">By Products</option>
                </select>
                <button onclick="exportResults()" class="text-xs bg-green-100 hover:bg-green-200 text-green-700 px-2 py-1 sm:px-3 sm:py-1 rounded-lg transition-colors flex items-center gap-1 flex-shrink-0">
                  <i class="fas fa-download text-xs"></i>
                  <span class="hidden sm:inline">Export</span>
                </button>
              </div>
            </div>
            <p id="resultsCount" class="text-sm text-gray-600"></p>
          </div>
          
          <div id="resultsContainer" class="grid grid-cols-1 lg:grid-cols-2 gap-3 sm:gap-4 lg:gap-6 custom-scrollbar max-h-[600px] overflow-y-auto"></div>
        </div>
      </div>

      <!-- Initial state -->
      <div id="initialState" class="bg-white rounded-2xl p-6 shadow-lg border border-gray-200">
        <div class="text-center py-12 text-gray-500">
          <svg class="w-16 h-16 mx-auto mb-4 text-gray-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
          </svg>
          <p class="text-lg">Enter a query above to search your database</p>
        </div>
      </div>
    </div>
  </div>

  <!-- Login Screen -->
  <div id="loginScreen" class="fixed inset-0 bg-gradient-to-br from-blue-600 to-purple-700 flex items-center justify-center z-50">
    <div class="bg-white rounded-2xl p-8 shadow-2xl max-w-md w-full mx-4">
      <div class="text-center mb-8">
        <div class="w-16 h-16 bg-blue-600 rounded-xl flex items-center justify-center mx-auto mb-4">
          <i class="fas fa-ship text-white text-2xl"></i>
        </div>
        <h1 class="text-2xl font-bold text-gray-800">Trade Intelligence</h1>
        <p class="text-gray-600">Please sign in to continue</p>
      </div>
      
      <form id="loginForm" onsubmit="handleLogin(event)">
        <div class="space-y-4">
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">Username</label>
            <input 
              type="text" 
              id="username" 
              required
              class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none"
              placeholder="Enter username"
            />
          </div>
          
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">Password</label>
            <input 
              type="password" 
              id="password" 
              required
              class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none"
              placeholder="Enter password"
            />
          </div>
          
          <div id="loginError" class="hidden bg-red-50 border border-red-200 rounded-lg p-3 text-red-700 text-sm">
            Invalid username or password
          </div>
          
          <button 
            type="submit" 
            class="w-full bg-blue-600 hover:bg-blue-700 text-white py-3 px-4 rounded-lg font-semibold transition-colors"
          >
            Sign In
          </button>
        </div>
      </form>
    </div>
  </div>

  <!-- Toast Notification Container -->
  <div id="toastContainer" class="fixed top-4 right-4 z-50 space-y-2">
    <!-- Toast notifications will be dynamically added here -->
  </div>

  <!-- Edit Modal -->
  <div id="editModal" class="fixed inset-0 bg-black bg-opacity-50 hidden flex items-center justify-center z-50">
    <div class="bg-white rounded-2xl p-4 max-w-sm w-full mx-4 shadow-2xl max-h-[90vh] overflow-y-auto">
      <div class="flex items-center justify-between mb-4">
        <h3 class="text-lg font-bold text-gray-800">Edit Record</h3>
        <button onclick="closeModal('editModal')" class="text-gray-400 hover:text-gray-600 p-1">
          <i class="fas fa-times"></i>
        </button>
      </div>
      <form id="modalEditForm" class="space-y-3"></form>
      <div class="flex gap-2 mt-4">
        <button onclick="closeModal('editModal')" class="flex-1 bg-gray-100 hover:bg-gray-200 text-gray-700 py-2 px-3 text-sm rounded-lg font-medium transition-colors">
          Cancel
        </button>
        <button onclick="submitModalEdit()" class="flex-1 bg-blue-600 hover:bg-blue-700 text-white py-2 px-3 text-sm rounded-lg font-medium transition-colors">
          Save
        </button>
      </div>
    </div>
  </div>

  <!-- Create Modal -->
  <div id="createModal" class="fixed inset-0 bg-black bg-opacity-50 hidden flex items-center justify-center z-50">
    <div class="bg-white rounded-2xl p-4 max-w-sm w-full mx-4 shadow-2xl max-h-[90vh] overflow-y-auto">
      <div class="flex items-center justify-between mb-4">
        <h3 class="text-lg font-bold text-gray-800">Create Company</h3>
        <button onclick="closeCreateModal()" class="text-gray-400 hover:text-gray-600 p-1">
          <i class="fas fa-times"></i>
        </button>
      </div>
      
      <form id="createForm" onsubmit="handleCreateSubmit(event)">
        <div class="space-y-3">
          <div>
            <label class="block text-xs font-medium text-gray-700 mb-1">Table</label>
            <select id="createTable" onchange="updateCreateFormFields()" class="w-full px-2 py-2 text-sm border border-gray-300 rounded-lg focus:border-blue-500">
              <option value="buyer">Buyers</option>
              <option value="seller">Sellers</option>
              <option value="gulfood">Gulfood</option>
            </select>
          </div>
          
          <div id="createFormFields">
            <!-- Dynamic fields will be populated here -->
          </div>
        </div>
        
        <div class="flex gap-2 mt-4">
          <button type="button" onclick="closeCreateModal()" class="flex-1 bg-gray-100 hover:bg-gray-200 text-gray-700 py-2 px-3 text-sm rounded-lg font-medium transition-colors">
            Cancel
          </button>
          <button type="submit" class="flex-1 bg-green-600 hover:bg-green-700 text-white py-2 px-3 text-sm rounded-lg font-medium transition-colors">
            Create
          </button>
        </div>
      </form>
    </div>
  </div>

<script>
// Enhanced Error Handling System
class ErrorHandler {
  static getErrorMessage(error, context = '') {
    // Network connectivity errors
    if (!navigator.onLine) {
      return {
        title: 'No Internet Connection',
        message: 'Please check your internet connection and try again.',
        type: 'error',
        icon: 'fas fa-wifi',
        retry: true
      };
    }

    // Failed to fetch errors (network issues)
    if (error.message?.includes('Failed to fetch') || error.message?.includes('NetworkError')) {
      return {
        title: 'Connection Failed',
        message: 'Unable to connect to server. Please check your connection and try again.',
        type: 'error',
        icon: 'fas fa-exclamation-triangle',
        retry: true
      };
    }

    // Timeout errors
    if (error.name === 'AbortError' || error.message?.includes('timeout')) {
      return {
        title: 'Request Timeout',
        message: 'The request took too long. Server may be busy. Please try again.',
        type: 'warning',
        icon: 'fas fa-clock',
        retry: true
      };
    }

    // Authentication errors
    if (error.message?.includes('401') || error.message?.includes('Unauthorized')) {
      return {
        title: 'Authentication Required',
        message: 'Your session has expired. Please log in again.',
        type: 'warning',
        icon: 'fas fa-lock',
        retry: false
      };
    }

    // Server errors (5xx)
    if (error.message?.includes('500') || error.message?.includes('502') || error.message?.includes('503')) {
      return {
        title: 'Server Error',
        message: 'Server is temporarily unavailable. Please try again in a few moments.',
        type: 'error',
        icon: 'fas fa-server',
        retry: true
      };
    }

    // Database errors
    if (context.includes('database') || error.message?.includes('Database')) {
      return {
        title: 'Database Error',
        message: 'Unable to access data. Please try again or contact support.',
        type: 'error',
        icon: 'fas fa-database',
        retry: true
      };
    }

    // Search/query specific errors
    if (context.includes('search')) {
      return {
        title: 'Search Failed',
        message: 'Unable to complete search. Please check your query and try again.',
        type: 'warning',
        icon: 'fas fa-search',
        retry: true
      };
    }

    // AI/Webhook errors
    if (context.includes('ai') || context.includes('webhook')) {
      return {
        title: 'AI Service Unavailable',
        message: 'Smart search is temporarily unavailable. Using basic search instead.',
        type: 'info',
        icon: 'fas fa-brain',
        retry: false
      };
    }

    // CORS errors
    if (error.message?.includes('CORS')) {
      return {
        title: 'Access Denied',
        message: 'Unable to access external service. Please contact administrator.',
        type: 'error',
        icon: 'fas fa-shield-alt',
        retry: false
      };
    }

    // Generic/unknown errors
    return {
      title: 'Something Went Wrong',
      message: error.message || 'An unexpected error occurred. Please try again.',
      type: 'error',
      icon: 'fas fa-exclamation-circle',
      retry: true
    };
  }

  static showError(error, context = '') {
    const errorInfo = this.getErrorMessage(error, context);
    showEnhancedToast(errorInfo.title, errorInfo.message, errorInfo.type, errorInfo.icon, errorInfo.retry);
  }
}

// Enhanced connection monitoring
class ConnectionMonitor {
  static isOnline = navigator.onLine;
  static reconnectAttempts = 0;
  static maxReconnectAttempts = 3;

  static init() {
    window.addEventListener('online', this.handleOnline.bind(this));
    window.addEventListener('offline', this.handleOffline.bind(this));
    
    // Periodic connectivity check
    setInterval(() => this.checkConnectivity(), 30000);
  }

  static handleOnline() {
    this.isOnline = true;
    this.reconnectAttempts = 0;
    this.updateConnectionStatus('online');
    this.hideConnectionBanner();
    showEnhancedToast('Connection Restored', 'You are back online', 'success', 'fas fa-wifi');
  }

  static handleOffline() {
    this.isOnline = false;
    this.updateConnectionStatus('offline');
    this.showConnectionBanner('No internet connection. Some features may not work properly.');
    showEnhancedToast('Connection Lost', 'You are offline', 'error', 'fas fa-wifi');
  }

  static updateConnectionStatus(status) {
    const statusElement = document.getElementById('connectionStatus');
    if (!statusElement) return;

    if (status === 'online') {
      statusElement.innerHTML = `
        <div class="w-2 h-2 bg-green-400 rounded-full animate-pulse"></div>
        <span class="text-sm text-green-600 font-medium text-white">Online</span>
      `;
    } else {
      statusElement.innerHTML = `
        <div class="w-2 h-2 bg-red-400 rounded-full"></div>
        <span class="text-sm text-red-600 font-medium text-white">Offline</span>
      `;
    }
  }

  static showConnectionBanner(message) {
    const banner = document.getElementById('connectionBanner');
    const messageElement = document.getElementById('connectionMessage');
    if (banner && messageElement) {
      messageElement.textContent = message;
      banner.classList.remove('hidden');
    }
  }

  static hideConnectionBanner() {
    const banner = document.getElementById('connectionBanner');
    if (banner) {
      banner.classList.add('hidden');
    }
  }

  static async checkConnectivity() {
    try {
      const response = await fetch('https://www.google.com/favicon.ico', {
        method: 'HEAD',
        mode: 'no-cors',
        cache: 'no-cache'
      });
      if (!this.isOnline) {
        this.handleOnline();
      }
    } catch (error) {
      if (this.isOnline) {
        this.handleOffline();
      }
    }
  }
}

// Enhanced toast notification system
function showEnhancedToast(title, message, type = 'success', icon = null, showRetry = false, duration = 5000) {
  const container = document.getElementById('toastContainer');
  const toastId = 'toast-' + Date.now();
  
  const config = {
    success: { bgColor: 'bg-green-500', borderColor: 'border-green-400' },
    error: { bgColor: 'bg-red-500', borderColor: 'border-red-400' },
    warning: { bgColor: 'bg-yellow-500', borderColor: 'border-yellow-400' },
    info: { bgColor: 'bg-blue-500', borderColor: 'border-blue-400' }
  };

  const { bgColor, borderColor } = config[type] || config.success;
  const displayIcon = icon || (type === 'success' ? 'fas fa-check-circle' : 
                               type === 'error' ? 'fas fa-exclamation-circle' :
                               type === 'warning' ? 'fas fa-exclamation-triangle' : 'fas fa-info-circle');
  
  const retryButton = showRetry ? `
    <button onclick="retryLastAction()" class="ml-2 text-white hover:text-gray-200 transition-colors text-xs underline">
      Retry
    </button>
  ` : '';
  
  const toast = document.createElement('div');
  toast.id = toastId;
  toast.className = `${bgColor} text-white px-4 py-3 rounded-lg shadow-lg border-l-4 ${borderColor} toast-enter max-w-sm`;
  
  toast.innerHTML = `
    <div class="flex items-start gap-3">
      <i class="${displayIcon} text-lg mt-0.5 flex-shrink-0"></i>
      <div class="flex-1 min-w-0">
        <div class="font-semibold text-sm">${title}</div>
        <div class="text-xs mt-1 text-white/90">${message}</div>
        ${retryButton}
      </div>
      <button onclick="removeToast('${toastId}')" class="text-white hover:text-gray-200 transition-colors flex-shrink-0 ml-2">
        <i class="fas fa-times text-sm"></i>
      </button>
    </div>
  `;
  
  container.appendChild(toast);
  
  setTimeout(() => {
    removeToast(toastId);
  }, duration);
}

// Store last action for retry functionality
let lastAction = null;

function setLastAction(action) {
  lastAction = action;
}

function retryLastAction() {
  if (lastAction && typeof lastAction === 'function') {
    lastAction();
  }
}

// Authentication System with enhanced error handling
const AUTH_WEBHOOK = 'https://m8taq6tk.rpcld.cc/webhook/login';

function checkAuthentication() {
  const isAuthenticated = localStorage.getItem('authenticated');
  const loginScreen = document.getElementById('loginScreen');
  
  if (isAuthenticated === 'true') {
    loginScreen.style.display = 'none';
    return true;
  } else {
    loginScreen.style.display = 'flex';
    return false;
  }
}

async function handleLogin(event) {
  event.preventDefault();
  
  const username = document.getElementById('username').value;
  const password = document.getElementById('password').value;
  const errorDiv = document.getElementById('loginError');
  const submitButton = event.target.querySelector('button[type="submit"]');
  
  // Show loading state
  const originalButtonText = submitButton.innerHTML;
  submitButton.disabled = true;
  submitButton.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Signing In...';
  
  try {
    // Check internet connection first
    if (!navigator.onLine) {
      throw new Error('No internet connection');
    }

    const response = await fetch(AUTH_WEBHOOK, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Accept': 'application/json'
      },
      body: JSON.stringify({
        "username": username,
        "password": password
      }),
      signal: AbortSignal.timeout(10000) // 10 second timeout
    });

    if (!response.ok) {
      if (response.status === 401) {
        throw new Error('Invalid credentials');
      } else if (response.status >= 500) {
        throw new Error('Server error - please try again later');
      } else {
        throw new Error(`Login failed (Error ${response.status})`);
      }
    }

    const result = await response.json();
    
    if (result.success === true) {
      localStorage.setItem('authenticated', 'true');
      localStorage.setItem('currentUser', result.username || username);
      document.getElementById('loginScreen').style.display = 'none';
      errorDiv.classList.add('hidden');
      
      showEnhancedToast('Login Successful', `Welcome back, ${result.username || username}!`, 'success', 'fas fa-user-check');
      initializeDashboard();
    } else {
      throw new Error(result.message || 'Invalid username or password');
    }
  } catch (error) {
    let errorMessage = 'Login failed. Please try again.';
    
    if (error.message?.includes('No internet connection')) {
      errorMessage = 'No internet connection. Please check your network and try again.';
    } else if (error.message?.includes('timeout')) {
      errorMessage = 'Login request timed out. Please try again.';
    } else if (error.message?.includes('Invalid credentials')) {
      errorMessage = 'Invalid username or password.';
    } else if (error.message?.includes('Server error')) {
      errorMessage = 'Server is temporarily unavailable. Please try again in a few moments.';
    } else if (error.message?.includes('Failed to fetch')) {
      errorMessage = 'Unable to connect to server. Please check your connection.';
    } else if (error.message) {
      errorMessage = error.message;
    }
    
    errorDiv.textContent = errorMessage;
    errorDiv.classList.remove('hidden');
    errorDiv.classList.add('error-shake');
    
    // Remove shake animation after it completes
    setTimeout(() => {
      errorDiv.classList.remove('error-shake');
    }, 500);
    
    document.getElementById('password').value = '';
    
    // Store retry action
    setLastAction(() => handleLogin(event));
  } finally {
    submitButton.disabled = false;
    submitButton.innerHTML = originalButtonText;
  }
}

function logout() {
  localStorage.removeItem('authenticated');
  localStorage.removeItem('currentUser');
  location.reload();
}

// Check if required dependencies are loaded
if (typeof supabase === 'undefined') {
  showEnhancedToast('Dependency Error', 'Failed to load database connection. Please refresh the page.', 'error', 'fas fa-exclamation-triangle', true);
}

if (typeof APP_CONFIG === 'undefined') {
  showEnhancedToast('Configuration Error', 'App configuration not loaded. Please check config.js file.', 'error', 'fas fa-cog', true);
}

const client = supabase.createClient(APP_CONFIG.supabaseUrl, APP_CONFIG.supabaseKey);
const tableFields = {
  buyer: ["buyer", "country", "category", "brands", "phone_number", "mail_id", "website"],
  seller: ["seller", "country", "category", "brands", "phone_number", "mail_id", "website"],
  gulfood: ["company_name", "address", "phone_number", "mail_id", "website"]
};

// Validate and normalize AI-generated filters
function validateAndNormalizeFilters(filters) {
  if (!filters || !Array.isArray(filters)) {
    return [];
  }
  
  return filters.map(filter => {
    if (!filter || typeof filter !== 'object') {
      return null;
    }
    
    const normalizedFilter = {
      field: filter.field || 'all',
      operator: filter.operator || 'ilike',
      value: filter.value || ''
    };
    
    if (normalizedFilter.operator === 'ilike' && normalizedFilter.value && 
        !normalizedFilter.value.startsWith('%') && !normalizedFilter.value.endsWith('%')) {
      normalizedFilter.value = `%${normalizedFilter.value}%`;
    }
    
    return normalizedFilter;
  }).filter(filter => filter !== null);
}

function filterForTable(filters, tableName) {
  const validFields = tableFields[tableName];
  
  return filters.filter(filter => {
    if (validFields.includes(filter.field)) {
      return true;
    }
    
    if (filter.field === 'buyer' && tableName === 'seller') {
      filter.field = 'seller';
      return true;
    } else if (filter.field === 'seller' && tableName === 'buyer') {
      filter.field = 'buyer';
      return true;
    } else if ((filter.field === 'buyer' || filter.field === 'seller') && tableName === 'gulfood') {
      filter.field = 'company_name';
      return true;
    } else if (filter.field === 'company_name' && (tableName === 'buyer' || tableName === 'seller')) {
      filter.field = tableName;
      return true;
    }
    
    const companySearchFields = ['company', 'name', 'business_name', 'firm', 'entity', 'all'];
    if (companySearchFields.includes(filter.field)) {
      if (tableName === 'buyer') {
        filter.field = 'buyer';
        return true;
      } else if (tableName === 'seller') {
        filter.field = 'seller';
        return true;
      } else if (tableName === 'gulfood') {
        filter.field = 'company_name';
        return true;
      }
    }
    
    if (filter.field === 'all') {
      if (tableName === 'buyer') {
        filter.field = 'buyer';
        return true;
      } else if (tableName === 'seller') {
        filter.field = 'seller';
        return true;
      } else if (tableName === 'gulfood') {
        filter.field = 'company_name';
        return true;
      }
    }
    
    return false;
  }).map(filter => ({...filter}));
}

let editContext = { id: null, table: null };

// Enhanced cache implementation
const queryCache = new Map();
const CACHE_DURATION = 5 * 60 * 1000; // 5 minutes

function getCacheKey(table, filters, page, pageSize) {
  return JSON.stringify({ table, filters, page, pageSize });
}

function getCachedResult(cacheKey) {
  const cached = queryCache.get(cacheKey);
  if (cached && Date.now() - cached.timestamp < CACHE_DURATION) {
    return cached.data;
  }
  return null;
}

function setCachedResult(cacheKey, data) {
  queryCache.set(cacheKey, {
    data,
    timestamp: Date.now()
  });
  
  if (queryCache.size > 100) {
    const oldEntries = Array.from(queryCache.entries())
      .filter(([_, entry]) => Date.now() - entry.timestamp > CACHE_DURATION);
    
    oldEntries.forEach(([key, _]) => queryCache.delete(key));
  }
}

function clearCache() {
  queryCache.clear();
}

function setSearchButtonLoading(isLoading) {
  const button = document.getElementById('searchButton');
  const icon = document.getElementById('searchIcon');
  const text = document.getElementById('searchText');
  
  if (isLoading) {
    button.disabled = true;
    button.classList.add('opacity-75', 'cursor-not-allowed');
    button.classList.remove('hover:bg-blue-700');
    icon.className = 'fas fa-spinner fa-spin text-xs sm:text-sm';
    text.textContent = 'Searching...';
  } else {
    button.disabled = false;
    button.classList.remove('opacity-75', 'cursor-not-allowed');
    button.classList.add('hover:bg-blue-700');
    icon.className = 'fas fa-search text-xs sm:text-sm';
    text.textContent = 'Search';
  }
}

// Legacy toast function for backward compatibility
function showToast(message, type = 'success', duration = 4000) {
  const title = type === 'success' ? 'Success' : 
               type === 'error' ? 'Error' : 
               type === 'warning' ? 'Warning' : 'Info';
  showEnhancedToast(title, message, type, null, false, duration);
}

function removeToast(toastId) {
  const toast = document.getElementById(toastId);
  if (toast) {
    toast.classList.remove('toast-enter');
    toast.classList.add('toast-exit');
    
    setTimeout(() => {
      if (toast.parentNode) {
        toast.parentNode.removeChild(toast);
      }
    }, 300);
  }
}

function openModal(id) {
  document.getElementById(id).classList.remove("hidden");
  document.body.style.overflow = 'hidden';
}

function closeModal(id) {
  document.getElementById(id).classList.add("hidden");
  document.body.style.overflow = 'auto';
}

function toggleAdvancedPanel() {
  const content = document.getElementById('advancedContent');
  const actions = document.getElementById('advancedActions');
  const icon = document.getElementById('advancedToggleIcon');
  
  if (content.classList.contains('hidden')) {
    content.classList.remove('hidden');
    content.classList.add('grid');
    actions.classList.remove('hidden');
    actions.classList.add('flex');
    icon.classList.remove('fa-chevron-right');
    icon.classList.add('fa-chevron-down');
  } else {
    content.classList.remove('grid');
    content.classList.add('hidden');
    actions.classList.remove('flex');
    actions.classList.add('hidden');
    icon.classList.remove('fa-chevron-down');
    icon.classList.add('fa-chevron-right');
  }
}

function setSearchQuery(query) {
  document.getElementById('searchInput').value = query;
  performSearch();
}

function openCreateModal() {
  updateCreateFields();
  openModal("createModal");
}

function openEditModal(record, table) {
  const fields = tableFields[table];
  const form = document.getElementById("modalEditForm");
  form.innerHTML = fields.map(f => `
    <div>
      <label class="block text-xs font-medium text-gray-700 mb-1">${f.replace('_', ' ').toUpperCase()}</label>
      <input name='${f}' value='${record[f] || ''}' 
             class='w-full px-2 py-2 text-sm border border-gray-300 rounded-lg focus:border-blue-500' />
    </div>
  `).join('');
  editContext = { id: record.id, table };
  openModal("editModal");
}

async function submitModalEdit() {
  try {
    const inputs = document.querySelectorAll("#modalEditForm input");
    const update = {};
    inputs.forEach(i => update[i.name] = i.value);
    
    const { error } = await client.from(editContext.table).update(update).eq("id", editContext.id);
    if (error) {
      ErrorHandler.showError(error, 'database');
      return;
    }
    
    showEnhancedToast("Update Successful", "Record updated successfully!", 'success');
    clearCache();
    closeModal("editModal");
    
    if (searchState.query) {
      setLastAction(() => performSearch());
      performSearch();
    }
  } catch (error) {
    ErrorHandler.showError(error, 'database');
  }
}

function renderRecord(r) {
  const fields = tableFields[r.__table];
  const tableColors = {
    buyer: 'border-l-blue-500',
    seller: 'border-l-green-500', 
    gulfood: 'border-l-purple-500'
  };
  
  const tableBadges = {
    buyer: { color: 'bg-blue-100 text-blue-700', icon: 'fas fa-shopping-cart', label: 'BUYER' },
    seller: { color: 'bg-green-100 text-green-700', icon: 'fas fa-store', label: 'SELLER' },
    gulfood: { color: 'bg-purple-100 text-purple-700', icon: 'fas fa-globe', label: 'GULFOOD' }
  };
  
  // Helper function to extract country from address for Gulfood records
  const getLocationInfo = (record) => {
    if (record.__table === 'gulfood') {
      // For Gulfood, use address and try to extract country from it
      const address = record.address || '';
      const location = address.split(',').pop()?.trim() || address || 'Unknown Location';
      
      // Try to match common country patterns
      const countryMatches = {
        'United Kingdom': 'ğŸ‡¬ğŸ‡§',
        'UK': 'ğŸ‡¬ğŸ‡§',
        'India': 'ğŸ‡®ğŸ‡³',
        'United States': 'ğŸ‡ºğŸ‡¸',
        'USA': 'ğŸ‡ºğŸ‡¸',
        'UAE': 'ğŸ‡¦ğŸ‡ª',
        'China': 'ğŸ‡¨ğŸ‡³',
        'Germany': 'ğŸ‡©ğŸ‡ª',
        'France': 'ğŸ‡«ğŸ‡·',
        'Italy': 'ğŸ‡®ğŸ‡¹',
        'Canada': 'ğŸ‡¨ğŸ‡¦',
        'Australia': 'ğŸ‡¦ğŸ‡º',
        'Japan': 'ğŸ‡¯ğŸ‡µ',
        'Singapore': 'ğŸ‡¸ğŸ‡¬',
        'Malaysia': 'ğŸ‡²ğŸ‡¾',
        'Thailand': 'ğŸ‡¹ğŸ‡­',
        'South Korea': 'ğŸ‡°ğŸ‡·',
        'Brazil': 'ğŸ‡§ğŸ‡·'
      };
      
      let flag = 'ğŸŒ'; // Default flag
      let displayLocation = location;
      
      // Check if any country name is found in the address
      for (const [country, countryFlag] of Object.entries(countryMatches)) {
        if (address.toLowerCase().includes(country.toLowerCase())) {
          flag = countryFlag;
          displayLocation = country;
          break;
        }
      }
      
      return { flag, location: displayLocation };
    } else {
      // For buyer/seller tables, use the country field
      const country = record.country || 'Unknown Location';
      const countryFlag = country === 'United Kingdom' ? 'ğŸ‡¬ğŸ‡§' : 
                         country === 'India' ? 'ğŸ‡®ğŸ‡³' :
                         country === 'United States' ? 'ğŸ‡ºğŸ‡¸' :
                         country === 'UAE' ? 'ğŸ‡¦ğŸ‡ª' :
                         country === 'China' ? 'ğŸ‡¨ğŸ‡³' :
                         country === 'Germany' ? 'ğŸ‡©ğŸ‡ª' :
                         country === 'France' ? 'ğŸ‡«ğŸ‡·' :
                         country === 'Italy' ? 'ğŸ‡®ğŸ‡¹' :
                         country === 'Canada' ? 'ğŸ‡¨ğŸ‡¦' :
                         country === 'Australia' ? 'ğŸ‡¦ğŸ‡º' :
                         country === 'Japan' ? 'ğŸ‡¯ğŸ‡µ' :
                         country === 'Singapore' ? 'ğŸ‡¸ğŸ‡¬' :
                         country === 'Malaysia' ? 'ğŸ‡²ğŸ‡¾' :
                         country === 'Thailand' ? 'ğŸ‡¹ğŸ‡­' :
                         country === 'South Korea' ? 'ğŸ‡°ğŸ‡·' :
                         country === 'Brazil' ? 'ğŸ‡§ğŸ‡·' : 'ğŸŒ';
      
      return { flag: countryFlag, location: country };
    }
  };
  
  const locationInfo = getLocationInfo(r);
  const badge = tableBadges[r.__table];
  
  return `
    <div class='bg-white p-3 sm:p-4 border border-gray-200 rounded-xl hover:shadow-lg transition-all duration-200 hover:border-gray-300 ${tableColors[r.__table]} border-l-4 relative' data-id='${r.id}' data-table='${r.__table}'>
      <div class='absolute top-2 right-2 sm:top-3 sm:right-3 flex gap-1'>
        <button onclick='openEditModal(${JSON.stringify(r)}, "${r.__table}")' 
                class='p-1 sm:p-1.5 text-blue-600 hover:bg-blue-50 rounded-lg text-xs transition-colors'>
          <i class='fas fa-edit'></i>
        </button>
        <button onclick='deleteRecord(this)' 
                class='p-1 sm:p-1.5 text-red-600 hover:bg-red-50 rounded-lg text-xs transition-colors'>
          <i class='fas fa-trash'></i>
        </button>
      </div>
      
      <div class='flex items-center gap-2 sm:gap-3 mb-2 sm:mb-3 pr-12 sm:pr-16'>
        <span class='text-base sm:text-lg'>${locationInfo.flag}</span>
        <div class='flex-1 min-w-0'>
          <h4 class='text-xs sm:text-sm font-bold text-gray-900 truncate leading-tight'>
            ${r.buyer || r.seller || r.company_name || 'Unnamed Record'}
          </h4>
          <p class='text-xs text-gray-500'>${locationInfo.location}</p>
        </div>
      </div>
      
      <div class='mb-2 sm:mb-3'>
        <span class='inline-flex items-center gap-1 px-1.5 py-0.5 sm:px-2 sm:py-1 rounded-full text-xs font-medium ${badge.color}'>
          <i class='${badge.icon} text-xs'></i>
          <span class='hidden sm:inline'>${badge.label}</span>
          <span class='sm:hidden'>${badge.label.slice(0,3).toUpperCase()}</span>
        </span>
      </div>
      
      <div class='space-y-1.5 sm:space-y-2 mb-2 sm:mb-3'>
        ${r.phone_number ? `
          <div class='flex items-center gap-2'>
            <i class='fas fa-phone text-green-600 text-xs w-3 sm:w-4'></i>
            <span class='text-xs sm:text-sm text-gray-600 truncate'>${r.phone_number}</span>
          </div>
        ` : ''}
        ${r.mail_id ? `
          <div class='flex items-center gap-2'>
            <i class='fas fa-envelope text-blue-600 text-xs w-3 sm:w-4'></i>
            <a href='mailto:${r.mail_id}' class='text-xs sm:text-sm text-blue-600 hover:text-blue-800 truncate'>${r.mail_id}</a>
          </div>
        ` : ''}
        ${r.website ? `
          <div class='flex items-center gap-2'>
            <i class='fas fa-globe text-purple-600 text-xs w-3 sm:w-4'></i>
            <a href='${r.website}' target='_blank' class='text-xs sm:text-sm text-purple-600 hover:text-purple-800 truncate'>${r.website}</a>
          </div>
        ` : ''}
        ${r.address ? `
          <div class='flex items-start gap-2'>
            <i class='fas fa-map-marker-alt text-red-600 text-xs w-3 sm:w-4 mt-0.5'></i>
            <span class='text-xs sm:text-sm text-gray-600 line-clamp-2'>${r.address}</span>
          </div>
        ` : ''}
      </div>
      
      ${(r.brands || r.category) ? `
        <div class='flex flex-wrap gap-1'>
          ${r.brands ? r.brands.split(',').slice(0, window.innerWidth < 640 ? 2 : 3).map(brand => `
            <span class='bg-gray-100 text-gray-700 px-1.5 py-0.5 sm:px-2 sm:py-1 rounded-full text-xs truncate max-w-[80px] sm:max-w-none'>${brand.trim()}</span>
          `).join('') : ''}
          ${r.category ? `
            <span class='bg-blue-100 text-blue-700 px-1.5 py-0.5 sm:px-2 sm:py-1 rounded-full text-xs truncate max-w-[100px] sm:max-w-none'>${r.category}</span>
          ` : ''}
          ${r.brands && r.brands.split(',').length > (window.innerWidth < 640 ? 2 : 3) ? `
            <span class='text-xs text-gray-400'>+${r.brands.split(',').length - (window.innerWidth < 640 ? 2 : 3)} more</span>
          ` : ''}
        </div>
      ` : ''}
    </div>
  `;
}

async function parseQueryWithAI(naturalQuery) {
  if (!APP_CONFIG.useWebhook || APP_CONFIG.webhookUrl === 'YOUR_WEBHOOK_URL_HERE') {
    return parseQueryFallback(naturalQuery);
  }

  try {
    if (!navigator.onLine) {
      throw new Error('No internet connection');
    }

    const controller = new AbortController();
    const timeoutId = setTimeout(() => controller.abort(), 15000);
    
    const response = await fetch(APP_CONFIG.webhookUrl, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Accept': 'application/json'
      },
      body: JSON.stringify({ query: naturalQuery }),
      signal: controller.signal
    });

    clearTimeout(timeoutId);

    if (!response.ok) {
      let errorMessage = `HTTP ${response.status}`;
      try {
        const errorData = await response.json();
        errorMessage = errorData.message || errorData.error || errorMessage;
      } catch (e) {
        errorMessage = response.statusText || errorMessage;
      }
      throw new Error(errorMessage);
    }

    const result = await response.json();
    
    if (result.success) {
      return {
        table: result.table,
        filters: result.filters
      };
    } else {
      throw new Error(result.error || 'AI service failed');
    }
    
  } catch (error) {
    if (error.name === 'AbortError') {
      showEnhancedToast('Request Timeout', 'AI service is taking too long. Using basic search instead.', 'warning', 'fas fa-clock');
    } else if (error.message.includes('Failed to fetch')) {
      showEnhancedToast('AI Service Unavailable', 'Smart search is temporarily unavailable. Using basic search instead.', 'info', 'fas fa-brain');
    }
    
    const fallbackResult = parseQueryFallback(naturalQuery);
    return fallbackResult;
  }
}

function parseQueryFallback(query) {
  const lowerQuery = query.toLowerCase();
  
  let table = "all";
  if (lowerQuery.includes("buyer") && !lowerQuery.includes("seller")) {
    table = "buyer";
  } else if (lowerQuery.includes("seller") && !lowerQuery.includes("buyer")) {
    table = "seller";
  } else if (lowerQuery.includes("gulfood")) {
    table = "gulfood";
  }
  
  const filters = [];
  
  if (lowerQuery.includes("find")) {
    const companyNameMatch = query.match(/find\s+(.+)/i);
    if (companyNameMatch) {
      const companyName = companyNameMatch[1].trim();
      filters.push({ field: "all", operator: "ilike", value: `%${companyName}%` });
    }
  }
  
  const countries = ["india", "uk", "united kingdom", "usa", "united states", "uae", "china", "germany", "france", "italy"];
  for (const country of countries) {
    if (lowerQuery.includes(country)) {
      const countryValue = country === "uk" ? "United Kingdom" : 
                          country === "usa" ? "United States" :
                          country.charAt(0).toUpperCase() + country.slice(1);
      filters.push({ field: "country", operator: "ilike", value: `%${countryValue}%` });
      break;
    }
  }
  
  if (table !== "gulfood") {
    const products = ["pepsi", "cosmetic", "fmcg", "food", "beverage"];
    for (const product of products) {
      if (lowerQuery.includes(product)) {
        filters.push({ field: "brands", operator: "ilike", value: `%${product}%` });
        filters.push({ field: "category", operator: "ilike", value: `%${product}%` });
        break;
      }
    }
  }
  
  return { table, filters };
}

async function fetchFrom(table, filters, page = 0, pageSize = 100) {
  const cacheKey = getCacheKey(table, filters, page, pageSize);
  
  const cachedResult = getCachedResult(cacheKey);
  if (cachedResult) {
    return cachedResult;
  }
  
  try {
    if (!navigator.onLine) {
      throw new Error('No internet connection');
    }

    let q = client.from(table).select("*", { count: 'exact' });
    const allowed = tableFields[table];
    
    if (filters && filters.length > 0) {
      for (const f of filters) {
        if (allowed.includes(f.field)) {
          if (f.operator === 'ilike') {
            q = q.ilike(f.field, f.value);
          } else if (f.operator === 'eq') {
            q = q.eq(f.field, f.value);
          }
        }
      }
    }
    
    const start = page * pageSize;
    const end = start + pageSize - 1;
    
    if (start >= 0) {
      q = q.range(start, end);
    }
    
    const { data, error, count } = await q;
    
    if (error) {
      throw new Error(`Database query failed: ${error.message}`);
    }
    
    const result = {
      data: (data || []).map(row => ({ ...row, __table: table })),
      count: count || 0,
      hasMore: (data || []).length === pageSize && count > (page + 1) * pageSize
    };
    
    setCachedResult(cacheKey, result);
    
    return result;
  } catch (error) {
    if (error.message.includes('No internet connection')) {
      throw new Error('No internet connection. Please check your network and try again.');
    }
    throw new Error(`Failed to fetch ${table} data: ${error.message}`);
  }
}

let searchState = { query: '', page: 0, hasMore: false, results: [] };

async function performSearch(loadMore = false) {
  const query = document.getElementById("searchInput").value.trim();
  const resultsContainer = document.getElementById("resultsContainer");
  const resultStats = document.getElementById("resultsCount");
  const resultsSection = document.getElementById("resultsSection");
  const initialState = document.getElementById("initialState");
  
  if (!query) {
    showEnhancedToast('Empty Query', 'Please enter a search query', 'warning', 'fas fa-search');
    return;
  }
  
  // Store search action for retry functionality
  setLastAction(() => performSearch(loadMore));
  
  if (!loadMore) {
    setSearchButtonLoading(true);
  }
  
  if (!loadMore || searchState.query !== query) {
    searchState = { query, page: 0, hasMore: false, results: [] };
    if (searchState.query !== query) {
      clearCache();
    }
  }
  
  resultsSection.classList.remove("hidden");
  initialState.style.display = "none";
  document.getElementById("productMatchingResults").classList.add("hidden");
  
  if (!loadMore) {
    resultsContainer.innerHTML = `
      <div class="col-span-full flex flex-col items-center py-8 sm:py-12">
        <div class="animate-spin rounded-full h-8 w-8 sm:h-12 sm:w-12 border-4 border-blue-600 border-t-transparent mb-3 sm:mb-4"></div>
        <p class="text-sm sm:text-base text-gray-600">Searching with AI...</p>
      </div>
    `;
    resultStats.innerHTML = "";
  }

  try {
    // Check internet connection
    if (!navigator.onLine) {
      throw new Error('No internet connection');
    }

    const ai = await parseQueryWithAI(query);
    
    const validatedFilters = validateAndNormalizeFilters(ai.filters);
    
    const isSpecificCompanySearch = query.toLowerCase().includes('find') && 
      validatedFilters.some(f => f.field === 'all' || f.field === 'company_name' || f.field === 'buyer' || f.field === 'seller' || 
        (f.value && f.value.length > 10 && /[A-Z]/.test(f.value)));
    
    if (isSpecificCompanySearch && ai.table === 'all') {
      const companyFilter = validatedFilters.find(f => 
        f.field === 'all' || f.field === 'company_name' || f.field === 'buyer' || f.field === 'seller' || 
        (f.value && f.value.length > 10)
      );
      
      if (companyFilter) {
        const companyValue = companyFilter.value;
        const otherFilters = validatedFilters.filter(f => f !== companyFilter);
        
        validatedFilters.length = 0;
        validatedFilters.push(
          ...otherFilters,
          { field: 'buyer', operator: 'ilike', value: companyValue },
          { field: 'seller', operator: 'ilike', value: companyValue },
          { field: 'company_name', operator: 'ilike', value: companyValue }
        );
      }
    }
    
    let newResults = [];
    let totalCount = 0;

    if (ai.table === "all") {
      const buyerFilters = filterForTable(validatedFilters, "buyer");
      const sellerFilters = filterForTable(validatedFilters, "seller");
      const gulfoodFilters = filterForTable(validatedFilters, "gulfood");
      
      const [buyerRes, sellerRes, gulfoodRes] = await Promise.all([
        fetchFrom("buyer", buyerFilters, searchState.page),
        fetchFrom("seller", sellerFilters, searchState.page),
        fetchFrom("gulfood", gulfoodFilters, searchState.page)
      ]);
      
      newResults = [...buyerRes.data, ...sellerRes.data, ...gulfoodRes.data];
      totalCount = buyerRes.count + sellerRes.count + gulfoodRes.count;
      searchState.hasMore = buyerRes.hasMore || sellerRes.hasMore || gulfoodRes.hasMore;
    } else if (ai.table === "gulfood") {
      const gulfoodFilters = filterForTable(validatedFilters, "gulfood");
      const result = await fetchFrom(ai.table, gulfoodFilters, searchState.page);
      newResults = result.data;
      totalCount = result.count;
      searchState.hasMore = result.hasMore;
    } else {
      const tableFilters = filterForTable(validatedFilters, ai.table);
      const result = await fetchFrom(ai.table, tableFilters, searchState.page);
      newResults = result.data;
      totalCount = result.count;
      searchState.hasMore = result.hasMore;
    }

    if (loadMore && newResults.length === 0) {
      searchState.hasMore = false;
    }

    if (loadMore) {
      searchState.results = [...searchState.results, ...newResults];
    } else {
      searchState.results = newResults;
    }
    
    if (searchState.results.length === 0) {
      resultsContainer.innerHTML = `
        <div class="col-span-full flex flex-col items-center py-12">
          <svg class="w-16 h-16 mb-4 text-gray-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.172 16.172a4 4 0 015.656 0M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
          </svg>
          <p class="text-lg text-gray-500">No results found</p>
          <p class="text-gray-400">Try adjusting your search terms or check your spelling</p>
        </div>
      `;
    } else {
      const resultsHTML = searchState.results.map(r => renderRecord(r)).join('');
      const loadMoreButton = searchState.hasMore ? `
        <div class="col-span-full flex justify-center mt-4 sm:mt-6">
          <button onclick="loadMoreResults()" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 sm:px-6 sm:py-3 rounded-lg font-medium transition-colors text-sm sm:text-base w-full sm:w-auto max-w-xs">
            Load More Results
          </button>
        </div>
      ` : '';
      
      resultsContainer.innerHTML = resultsHTML + loadMoreButton;
    }
    
    // Short color-coded results message
    const formatResultsMessage = (total, showing, query) => {
      if (total === 1) {
        return `<span style="color: #059669; font-weight: 600;">${total}</span> result found`;
      } else if (showing >= total) {
        return `<span style="color: #2563eb; font-weight: 600;">${total}</span> results found`;
      } else {
        return `<span style="color: #2563eb; font-weight: 600;">${total}</span> found â€¢ <span style="color: #059669; font-weight: 600;">${showing}</span> shown`;
      }
    };
    
    resultStats.innerHTML = formatResultsMessage(totalCount, searchState.results.length, query);
    searchState.page++;
    
  } catch (error) {
    ErrorHandler.showError(error, 'search');
    showErrorMessage(error.message);
  } finally {
    if (!loadMore) {
      setSearchButtonLoading(false);
    }
  }
}

function loadMoreResults() {
  const loadMoreBtn = document.querySelector('button[onclick="loadMoreResults()"]');
  if (loadMoreBtn) {
    loadMoreBtn.disabled = true;
    loadMoreBtn.innerHTML = '<i class="fas fa-spinner animate-spin mr-2"></i>Loading...';
  }
  
  performSearch(true).finally(() => {
    if (loadMoreBtn && !loadMoreBtn.closest('.col-span-full').removed) {
      loadMoreBtn.disabled = false;
      loadMoreBtn.innerHTML = 'Load More Results';
    }
  });
}

function showErrorMessage(message) {
  const resultsContainer = document.getElementById("resultsContainer");
  const resultsSection = document.getElementById("resultsSection");
  const initialState = document.getElementById("initialState");
  
  resultsSection.classList.remove("hidden");
  initialState.style.display = "none";
  
  let retryButton = '';
  if (lastAction) {
    retryButton = `
      <button onclick="retryLastAction()" class="mt-4 bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg transition-colors">
        <i class="fas fa-redo mr-2"></i>Try Again
      </button>
    `;
  }
  
  resultsContainer.innerHTML = `
    <div class='col-span-full'>
      <div class='bg-red-50 border border-red-200 rounded-xl p-6 text-center'>
        <svg class="w-12 h-12 mx-auto mb-4 text-red-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
        </svg>
        <h3 class="text-lg font-semibold text-red-900 mb-2">Search Failed</h3>
        <p class="text-red-700 mb-4">${message}</p>
        <div class="flex gap-2 justify-center">
          <button onclick="clearResults()" class="bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded-lg transition-colors">
            <i class="fas fa-times mr-2"></i>Clear
          </button>
          ${retryButton}
        </div>
      </div>
    </div>
  `;
}

async function performAdvancedSearch() {
  const searchType = document.getElementById("searchType").value;
  const productSearch = document.getElementById("productSearch").value;
  const countryFilter = document.getElementById("countryFilter").value;
  
  let query = "";
  
  if (searchType === "buyer") {
    query = "all buyers";
  } else if (searchType === "seller") {
    query = "all sellers";
  } else {
    query = "all companies";
  }
  
  if (productSearch) {
    query += ` with ${productSearch}`;
  }
  
  if (countryFilter) {
    query += ` from ${countryFilter}`;
  }
  
  document.getElementById("searchInput").value = query;
  performSearch();
}

// Country suggestions functionality
let allCountries = [];
let countrySuggestionsTimeout;

async function loadAllCountries() {
  try {
    const [buyerCountries, sellerCountries] = await Promise.all([
      client.from('buyer').select('country').not('country', 'is', null),
      client.from('seller').select('country').not('country', 'is', null)
    ]);
    
    const countrySet = new Set();
    
    [...(buyerCountries.data || []), ...(sellerCountries.data || [])]
      .forEach(item => {
        if (item.country && item.country.trim()) {
          countrySet.add(item.country.trim());
        }
      });
    
    allCountries = Array.from(countrySet).sort();
  } catch (error) {
    allCountries = [
      'India', 'United Kingdom', 'United States', 'UAE', 'China', 
      'Germany', 'France', 'Italy', 'Canada', 'Australia', 'Japan',
      'Singapore', 'Malaysia', 'Thailand', 'South Korea', 'Brazil'
    ];
  }
}

function showCountrySuggestions() {
  const input = document.getElementById('countryFilter');
  const suggestions = document.getElementById('countrySuggestions');
  const query = input.value.toLowerCase().trim();
  
  clearTimeout(countrySuggestionsTimeout);
  
  countrySuggestionsTimeout = setTimeout(() => {
    if (allCountries.length === 0) {
      loadAllCountries().then(() => showCountrySuggestions());
      return;
    }
    
    const filteredCountries = allCountries.filter(country => 
      country.toLowerCase().includes(query)
    ).slice(0, 10);
    
    if (filteredCountries.length > 0) {
      suggestions.innerHTML = filteredCountries.map(country => `
        <div class="px-3 py-2 hover:bg-blue-50 cursor-pointer border-b border-gray-100 last:border-b-0" 
             onclick="selectCountry('${country}')">
          ${country}
        </div>
      `).join('');
      suggestions.classList.remove('hidden');
    } else {
      suggestions.classList.add('hidden');
    }
  }, 150);
}

function hideCountrySuggestions() {
  setTimeout(() => {
    document.getElementById('countrySuggestions').classList.add('hidden');
  }, 200);
}

function selectCountry(country) {
  document.getElementById('countryFilter').value = country;
  document.getElementById('countrySuggestions').classList.add('hidden');
}

async function performProductMatching() {
  const productSearch = document.getElementById("productSearch").value.trim();
  const countryFilter = document.getElementById("countryFilter").value;
  
  if (!productSearch) {
    showEnhancedToast('Missing Input', 'Please enter a product/brand to find mapping', 'warning', 'fas fa-exclamation-triangle');
    return;
  }
  
  // Store action for retry
  setLastAction(() => performProductMatching());
  
  document.getElementById("productMatchingResults").classList.remove("hidden");
  document.getElementById("resultsSection").classList.add("hidden");
  document.getElementById("initialState").style.display = "none";
  
  const productHeader = document.getElementById("productInfoHeader");
  productHeader.innerHTML = `
    <div class="flex items-center justify-between">
      <div>
        <h3 class="text-base sm:text-lg font-bold text-gray-800">Product: ${productSearch}</h3>
        ${countryFilter ? `<p class="text-sm sm:text-base text-gray-600">Filtered by: ${countryFilter}</p>` : ''}
      </div>
      <div class="flex items-center gap-4">
        <span class="text-sm sm:text-base text-blue-600 font-semibold" id="buyersCount">0 Buyers</span>
        <span class="text-sm sm:text-base text-green-600 font-semibold" id="sellersCount">0 Sellers</span>
      </div>
    </div>
  `;
  
  document.getElementById("buyersList").innerHTML = `
    <div class="text-center py-8">
      <div class="animate-spin rounded-full h-8 w-8 border-2 border-blue-600 border-t-transparent mx-auto mb-2"></div>
      <p class="text-blue-600 text-sm">Loading buyers...</p>
    </div>
  `;
  document.getElementById("sellersList").innerHTML = `
    <div class="text-center py-8">
      <div class="animate-spin rounded-full h-8 w-8 border-2 border-green-600 border-t-transparent mx-auto mb-2"></div>
      <p class="text-green-600 text-sm">Loading sellers...</p>
    </div>
  `;
  
  try {
    if (!navigator.onLine) {
      throw new Error('No internet connection');
    }

    const fetchOptimizedBuyers = async () => {
      try {
        let query = client.from("buyer").select("*", { count: 'exact' });
        
        query = query.or(`brands.ilike.%${productSearch}%,category.ilike.%${productSearch}%,buyer.ilike.%${productSearch}%`);
        
        if (countryFilter && countryFilter !== "") {
          query = query.eq("country", countryFilter);
        }
        
        query = query.range(0, 199);
        
        const { data, error, count } = await query;
        if (error) throw error;
        
        return {
          data: (data || []).map(row => ({ ...row, __table: 'buyer' })),
          count: count || 0
        };
      } catch (error) {
        throw new Error(`Failed to fetch buyers: ${error.message}`);
      }
    };

    const fetchOptimizedSellers = async () => {
      try {
        let query = client.from("seller").select("*", { count: 'exact' });
        
        query = query.or(`brands.ilike.%${productSearch}%,category.ilike.%${productSearch}%,seller.ilike.%${productSearch}%`);
        
        if (countryFilter && countryFilter !== "") {
          query = query.eq("country", countryFilter);
        }
        
        query = query.range(0, 199);
        
        const { data, error, count } = await query;
        if (error) throw error;
        
        return {
          data: (data || []).map(row => ({ ...row, __table: 'seller' })),
          count: count || 0
        };
      } catch (error) {
        throw new Error(`Failed to fetch sellers: ${error.message}`);
      }
    };
    
    const [buyerResult, sellerResult] = await Promise.all([
      fetchOptimizedBuyers(),
      fetchOptimizedSellers()
    ]);
    
    const buyers = buyerResult.data;
    const sellers = sellerResult.data;
    
    document.getElementById("buyersTitle").textContent = `Buyers (${buyerResult.count})`;
    document.getElementById("sellersTitle").textContent = `Sellers (${sellerResult.count})`;
    document.getElementById("buyersCount").textContent = `${buyerResult.count} Buyers`;
    document.getElementById("sellersCount").textContent = `${sellerResult.count} Sellers`;
    
    if (buyers.length === 0) {
      document.getElementById("buyersList").innerHTML = `
        <div class="text-center py-8 text-gray-500">
          <i class="fas fa-search text-2xl mb-2"></i>
          <p>No buyers found for "${productSearch}"</p>
          <p class="text-xs mt-1">Try different search terms</p>
        </div>
      `;
    } else {
      document.getElementById("buyersList").innerHTML = buyers.map(buyer => renderMappingCard(buyer)).join('');
    }
    
    if (sellers.length === 0) {
      document.getElementById("sellersList").innerHTML = `
        <div class="text-center py-8 text-gray-500">
          <i class="fas fa-search text-2xl mb-2"></i>
          <p>No sellers found for "${productSearch}"</p>
          <p class="text-xs mt-1">Try different search terms</p>
        </div>
      `;
    } else {
      document.getElementById("sellersList").innerHTML = sellers.map(seller => renderMappingCard(seller)).join('');
    }
    
  } catch (error) {
    ErrorHandler.showError(error, 'database');
    
    const errorHtml = `
      <div class="bg-red-50 border border-red-200 rounded-lg p-4 text-center">
        <i class="fas fa-exclamation-triangle text-red-600 mb-2"></i>
        <p class="text-red-700 text-sm">Error loading data: ${error.message}</p>
        <button onclick="performProductMatching()" class="mt-2 text-xs bg-red-100 hover:bg-red-200 text-red-700 px-2 py-1 rounded">
          Try Again
        </button>
      </div>
    `;
    
    document.getElementById("buyersList").innerHTML = errorHtml;
    document.getElementById("sellersList").innerHTML = errorHtml;
  }
}

function renderMappingCard(record) {
  // Helper function to get location info for both regular and Gulfood records
  const getLocationInfo = (record) => {
    if (record.__table === 'gulfood') {
      const address = record.address || '';
      const location = address.split(',').pop()?.trim() || address || 'Unknown Location';
      
      const countryMatches = {
        'United Kingdom': 'ğŸ‡¬ğŸ‡§',
        'UK': 'ğŸ‡¬ğŸ‡§',
        'India': 'ğŸ‡®ğŸ‡³',
        'United States': 'ğŸ‡ºğŸ‡¸',
        'USA': 'ğŸ‡ºğŸ‡¸',
        'UAE': 'ğŸ‡¦ğŸ‡ª',
        'China': 'ğŸ‡¨ğŸ‡³',
        'Germany': 'ğŸ‡©ğŸ‡ª',
        'France': 'ğŸ‡«ğŸ‡·',
        'Italy': 'ğŸ‡®ğŸ‡¹',
        'Canada': 'ğŸ‡¨ğŸ‡¦',
        'Australia': 'ğŸ‡¦ğŸ‡º',
        'Japan': 'ğŸ‡¯ğŸ‡µ',
        'Singapore': 'ğŸ‡¸ğŸ‡¬',
        'Malaysia': 'ğŸ‡²ğŸ‡¾',
        'Thailand': 'ğŸ‡¹ğŸ‡­',
        'South Korea': 'ğŸ‡°ğŸ‡·',
        'Brazil': 'ğŸ‡§ğŸ‡·'
      };
      
      let flag = 'ğŸŒ';
      let displayLocation = location;
      
      for (const [country, countryFlag] of Object.entries(countryMatches)) {
        if (address.toLowerCase().includes(country.toLowerCase())) {
          flag = countryFlag;
          displayLocation = country;
          break;
        }
      }
      
      return { flag, location: displayLocation };
    } else {
      const country = record.country || 'Unknown Location';
      const countryFlag = country === 'United Kingdom' ? 'ğŸ‡¬ğŸ‡§' : 
                         country === 'India' ? 'ğŸ‡®ğŸ‡³' :
                         country === 'United States' ? 'ğŸ‡ºğŸ‡¸' :
                         country === 'UAE' ? 'ğŸ‡¦ğŸ‡ª' :
                         country === 'China' ? 'ğŸ‡¨ğŸ‡³' :
                         country === 'Germany' ? 'ğŸ‡©ğŸ‡ª' :
                         country === 'France' ? 'ğŸ‡«ğŸ‡·' :
                         country === 'Italy' ? 'ğŸ‡®ğŸ‡¹' :
                         country === 'Canada' ? 'ğŸ‡¨ğŸ‡¦' :
                         country === 'Australia' ? 'ğŸ‡¦ğŸ‡º' :
                         country === 'Japan' ? 'ğŸ‡¯ğŸ‡µ' :
                         country === 'Singapore' ? 'ğŸ‡¸ğŸ‡¬' :
                         country === 'Malaysia' ? 'ğŸ‡²ğŸ‡¾' :
                         country === 'Thailand' ? 'ğŸ‡¹ğŸ‡­' :
                         country === 'South Korea' ? 'ğŸ‡°ğŸ‡·' :
                         country === 'Brazil' ? 'ğŸ‡§ğŸ‡·' : 'ğŸŒ';
      
      return { flag: countryFlag, location: country };
    }
  };
  
  const locationInfo = getLocationInfo(record);
  const companyName = record.buyer || record.seller || record.company_name || 'Unnamed Company';
  
  return `
    <div class="bg-white rounded-lg p-4 border border-gray-200 hover:shadow-md transition-all mb-3">
      <div class="flex items-center gap-2 mb-3">
        <span class="text-lg">${locationInfo.flag}</span>
        <h5 class="font-bold text-gray-900 text-sm flex-1">${companyName}</h5>
      </div>
      
      <div class="space-y-2">
        <div class="text-xs text-gray-600">
          <i class="fas fa-map-marker-alt mr-1"></i>
          ${locationInfo.location}
        </div>
        
        ${record.mail_id ? `
          <div class="text-xs text-blue-600">
            <i class="fas fa-envelope mr-1"></i>
            <a href="mailto:${record.mail_id}" class="hover:underline">${record.mail_id}</a>
          </div>
        ` : ''}
        
        ${record.phone_number ? `
          <div class="text-xs text-green-600">
            <i class="fas fa-phone mr-1"></i>
            ${record.phone_number}
          </div>
        ` : ''}
        
        ${record.website ? `
          <div class="text-xs text-purple-600">
            <i class="fas fa-globe mr-1"></i>
            <a href="${record.website}" target="_blank" class="hover:underline">${record.website}</a>
          </div>
        ` : ''}
        
        ${record.address && record.__table === 'gulfood' ? `
          <div class="text-xs text-gray-700 mt-2 pt-2 border-t border-gray-100">
            <span class="font-medium">Address:</span> 
            <span class="text-gray-600">${record.address}</span>
          </div>
        ` : ''}
        
        ${record.brands ? `
          <div class="text-xs text-gray-700 mt-2 pt-2 border-t border-gray-100">
            <span class="font-medium">Products:</span> 
            <span class="text-gray-600">${record.brands}</span>
          </div>
        ` : ''}
        
        ${record.category ? `
          <div class="text-xs text-gray-700">
            <span class="font-medium">Category:</span> 
            <span class="text-gray-600">${record.category}</span>
          </div>
        ` : ''}
      </div>
    </div>
  `;
}

function closeProductMapping() {
  document.getElementById("productMatchingResults").classList.add("hidden");
  document.getElementById("resultsSection").classList.add("hidden");
  document.getElementById("initialState").style.display = "block";
}

function resetAdvancedFilters() {
  document.getElementById("searchType").value = "all";
  document.getElementById("productSearch").value = "";
  document.getElementById("countryFilter").value = "";
}

function sortResults() {
  const sortBy = document.getElementById('sortBy')?.value;
  if (!sortBy || sortBy === 'default') {
    return;
  }
  
  if (!searchState.results || searchState.results.length === 0) {
    return;
  }
  
  const sorted = [...searchState.results].sort((a, b) => {
    let aVal = '';
    let bVal = '';
    
    switch(sortBy) {
      case 'name':
        aVal = a.buyer || a.seller || a.company_name || '';
        bVal = b.buyer || b.seller || b.company_name || '';
        break;
      case 'country':
        aVal = a.country || '';
        bVal = b.country || '';
        break;
      case 'products':
        aVal = a.brands || a.category || '';
        bVal = b.brands || b.category || '';
        break;
      default:
        return 0;
    }
    
    return aVal.localeCompare(bVal);
  });
  
  searchState.results = sorted;
  
  const resultsContainer = document.getElementById("resultsContainer");
  if (resultsContainer) {
    const resultsHTML = searchState.results.map(r => renderRecord(r)).join('');
    resultsContainer.innerHTML = resultsHTML;
  }
}

function exportResults() {
  if (!searchState.results || searchState.results.length === 0) {
    showEnhancedToast('No Data', 'No results to export', 'warning', 'fas fa-file-export');
    return;
  }
  
  try {
    const headers = ['Name', 'Country', 'Type', 'Products/Category', 'Phone', 'Email', 'Website'];
    const rows = searchState.results.map(r => [
      r.buyer || r.seller || r.company_name || '',
      r.country || '',
      r.__table || '',
      r.brands || r.category || '',
      r.phone_number || '',
      r.mail_id || '',
      r.website || ''
    ]);
    
    const csvContent = [headers, ...rows]
      .map(row => row.map(field => `"${field}"`).join(','))
      .join('\n');
    
    const blob = new Blob([csvContent], { type: 'text/csv' });
    const url = window.URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `search_results_${new Date().toISOString().split('T')[0]}.csv`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    window.URL.revokeObjectURL(url);
    
    showEnhancedToast('Export Successful', `Exported ${searchState.results.length} records successfully`, 'success', 'fas fa-download');
  } catch (error) {
    ErrorHandler.showError(error, 'export');
  }
}

function quickSearch(type) {
  const searchInput = document.getElementById("searchInput");
  if (searchInput) {
    searchInput.value = type;
    performSearch();
  }
}

function clearResults() {
  const resultsSection = document.getElementById("resultsSection");
  const initialState = document.getElementById("initialState");
  const searchInput = document.getElementById("searchInput");
  
  if (resultsSection) {
    resultsSection.classList.add("hidden");
  }
  
  if (initialState) {
    initialState.style.display = "block";
  }
  
  if (searchInput) {
    searchInput.value = "";
  }
  
  document.getElementById("productMatchingResults").classList.add("hidden");
  
  searchState = { query: '', page: 0, hasMore: false, results: [] };
}

async function deleteRecord(btn) {
  try {
    const card = btn.closest("[data-id]");
    if (!card) {
      return;
    }
    
    const table = card.dataset.table;
    const id = card.dataset.id;
    
    if (!table || !id) {
      showEnhancedToast('Delete Error', 'Could not delete: missing record information', 'error', 'fas fa-exclamation-triangle');
      return;
    }
    
    if (!confirm("Delete this record? This action cannot be undone.")) return;
    
    if (!navigator.onLine) {
      throw new Error('No internet connection');
    }
    
    const { error } = await client.from(table).delete().eq("id", id);
    if (error) {
      throw new Error(error.message);
    }
    
    showEnhancedToast('Delete Successful', 'Record deleted successfully', 'success', 'fas fa-trash');
    clearCache();
    
    if (searchState.query) {
      setLastAction(() => performSearch());
      performSearch();
    }
  } catch (error) {
    ErrorHandler.showError(error, 'database');
  }
}

// Table field definitions based on CSV structure
const tableFieldsDefinition = {
  buyer: [
    { name: 'buyer', label: 'Company Name', type: 'text', required: true },
    { name: 'country', label: 'Country', type: 'text', required: true },
    { name: 'phone_number', label: 'Phone Number', type: 'tel', required: false },
    { name: 'mail_id', label: 'Email', type: 'email', required: false },
    { name: 'website', label: 'Website', type: 'url', required: false },
    { name: 'category', label: 'Category', type: 'text', required: false },
    { name: 'brands', label: 'Brands', type: 'text', required: false }
  ],
  gulfood: [
    { name: 'company_name', label: 'Company Name', type: 'text', required: true },
    { name: 'address', label: 'Address', type: 'text', required: false },
    { name: 'phone_number', label: 'Phone Number', type: 'tel', required: false },
    { name: 'mail_id', label: 'Email', type: 'email', required: false },
    { name: 'website', label: 'Website', type: 'url', required: false }
  ]
};

function updateCreateFormFields() {
  const table = document.getElementById('createTable').value;
  const fields = tableFieldsDefinition[table];
  const container = document.getElementById('createFormFields');
  
  container.innerHTML = fields.map(field => `
    <div>
      <label class="block text-xs font-medium text-gray-700 mb-1">
        ${field.label} ${field.required ? '*' : ''}
      </label>
      <input 
        type="${field.type}" 
        name="${field.name}" 
        ${field.required ? 'required' : ''}
        class="w-full px-2 py-2 text-sm border border-gray-300 rounded-lg focus:border-blue-500"
        placeholder="Enter ${field.label.toLowerCase()}"
      >
    </div>
  `).join('');
}

// Create Modal Functions
function openCreateModal() {
  document.getElementById('createModal').classList.remove('hidden');
  updateCreateFormFields();
}

function closeCreateModal() {
  document.getElementById('createModal').classList.add('hidden');
  document.getElementById('createForm').reset();
}

async function handleCreateSubmit(event) {
  event.preventDefault();
  
  try {
    if (!navigator.onLine) {
      throw new Error('No internet connection');
    }

    const table = document.getElementById('createTable').value;
    const formData = new FormData(event.target);
    const data = {};
    
    for (let [key, value] of formData.entries()) {
      if (value.trim()) {
        data[key] = value.trim();
      }
    }
    
    // Validate required fields
    const requiredFields = tableFieldsDefinition[table].filter(field => field.required);
    const missingFields = requiredFields.filter(field => !data[field.name]);
    
    if (missingFields.length > 0) {
      throw new Error(`Missing required fields: ${missingFields.map(f => f.label).join(', ')}`);
    }
    
    const { data: result, error } = await client.from(table).insert([data]);
    if (error) {
      throw new Error(error.message);
    }
    
    showEnhancedToast("Create Successful", "Record created successfully!", 'success', 'fas fa-plus-circle');
    clearCache();
    closeCreateModal();
    
    if (searchState.query) {
      setLastAction(() => performSearch());
      performSearch();
    }
  } catch (error) {
    ErrorHandler.showError(error, 'database');
  }
}

function updateLastUpdated() {
  const now = new Date();
  const timeString = now.toLocaleTimeString('en-US', { 
    hour12: true,
    hour: 'numeric',
    minute: '2-digit',
    second: '2-digit'
  });
  const lastUpdatedElement = document.getElementById('lastUpdated');
  if (lastUpdatedElement) {
    lastUpdatedElement.textContent = timeString;
  }
}

function initializeDashboard() {
  try {
    const searchInput = document.getElementById('searchInput');
    
    if (!searchInput) {
      showEnhancedToast('Initialization Error', 'Failed to initialize dashboard elements', 'error', 'fas fa-exclamation-triangle', true);
      return;
    }
    
    // Initialize connection monitoring
    ConnectionMonitor.init();
    
    // Search on Enter
    searchInput.addEventListener('keypress', function(e) {
      if (e.key === 'Enter') {
        performSearch();
      }
    });
    
    // Load countries for suggestions
    loadAllCountries().catch(error => {
      console.warn('Failed to load countries:', error.message);
    });
    
    // Update last updated time
    updateLastUpdated();
    setInterval(updateLastUpdated, 1000);
    
    // Test database connection
    testDatabaseConnection();
    
  } catch (error) {
    showEnhancedToast('Dashboard Error', 'Failed to initialize dashboard. Please refresh the page.', 'error', 'fas fa-exclamation-triangle', true);
  }
}

// Test database connection on startup
async function testDatabaseConnection() {
  try {
    const { data, error } = await client.from('buyer').select('id').limit(1);
    if (error) {
      throw error;
    }
    console.log('Database connection successful');
  } catch (error) {
    showEnhancedToast('Database Connection', 'Unable to connect to database. Some features may not work properly.', 'warning', 'fas fa-database');
    ConnectionMonitor.updateConnectionStatus('offline');
  }
}

// Enhanced error boundary for unexpected errors
window.addEventListener('error', function(event) {
  console.error('Unexpected error:', event.error);
  showEnhancedToast('Unexpected Error', 'Something went wrong. Please refresh the page if problems persist.', 'error', 'fas fa-bug', true);
});

window.addEventListener('unhandledrejection', function(event) {
  console.error('Unhandled promise rejection:', event.reason);
  if (event.reason && typeof event.reason === 'object' && event.reason.message) {
    ErrorHandler.showError(event.reason);
  } else {
    showEnhancedToast('System Error', 'An unexpected error occurred. Please try again.', 'error', 'fas fa-exclamation-triangle', true);
  }
});

// Initialize on DOM load
document.addEventListener('DOMContentLoaded', function() {
  if (checkAuthentication()) {
    initializeDashboard();
  }
});

// Additional utility functions for better UX
function showLoadingState(element, message = 'Loading...') {
  if (element) {
    element.innerHTML = `
      <div class="flex items-center justify-center py-4">
        <div class="animate-spin rounded-full h-6 w-6 border-2 border-blue-600 border-t-transparent mr-2"></div>
        <span class="text-gray-600">${message}</span>
      </div>
    `;
  }
}

function validateEmail(email) {
  const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
  return emailRegex.test(email);
}

function validateURL(url) {
  try {
    new URL(url);
    return true;
  } catch {
    return false;
  }
}

function validatePhone(phone) {
  const phoneRegex = /^[\+]?[1-9][\d]{0,15}$/;
  return phoneRegex.test(phone.replace(/[\s\-\(\)]/g, ''));
}

// Enhanced form validation
function validateCreateForm(data, table) {
  const errors = [];
  const fields = tableFieldsDefinition[table];
  
  fields.forEach(field => {
    const value = data[field.name];
    
    if (field.required && (!value || !value.trim())) {
      errors.push(`${field.label} is required`);
      return;
    }
    
    if (value && value.trim()) {
      switch (field.type) {
        case 'email':
          if (!validateEmail(value)) {
            errors.push(`${field.label} must be a valid email address`);
          }
          break;
        case 'url':
          if (!validateURL(value)) {
            errors.push(`${field.label} must be a valid URL`);
          }
          break;
        case 'tel':
          if (!validatePhone(value)) {
            errors.push(`${field.label} must be a valid phone number`);
          }
          break;
      }
    }
  });
  
  return errors;
}

// Keyboard shortcuts
document.addEventListener('keydown', function(event) {
  // Ctrl/Cmd + K for search focus
  if ((event.ctrlKey || event.metaKey) && event.key === 'k') {
    event.preventDefault();
    const searchInput = document.getElementById('searchInput');
    if (searchInput) {
      searchInput.focus();
      searchInput.select();
    }
  }
  
  // Escape to clear search or close modals
  if (event.key === 'Escape') {
    const activeModal = document.querySelector('.fixed:not(.hidden)');
    if (activeModal && activeModal.id !== 'loginScreen') {
      if (activeModal.id === 'editModal') closeModal('editModal');
      if (activeModal.id === 'createModal') closeCreateModal();
    } else {
      clearResults();
    }
  }
});

// Auto-retry functionality for failed requests
class RetryManager {
  static retryQueue = [];
  static isRetrying = false;
  
  static addToQueue(action, context = '') {
    this.retryQueue.push({ action, context, attempts: 0 });
  }
  
  static async processQueue() {
    if (this.isRetrying || this.retryQueue.length === 0) return;
    
    this.isRetrying = true;
    
    while (this.retryQueue.length > 0) {
      const item = this.retryQueue.shift();
      
      try {
        await item.action();
        showEnhancedToast('Retry Successful', `${item.context} completed successfully`, 'success', 'fas fa-check-circle');
      } catch (error) {
        item.attempts++;
        
        if (item.attempts < 3) {
          this.retryQueue.push(item);
          await new Promise(resolve => setTimeout(resolve, 2000 * item.attempts)); // Exponential backoff
        } else {
          showEnhancedToast('Retry Failed', `${item.context} failed after 3 attempts`, 'error', 'fas fa-times-circle');
        }
      }
    }
    
    this.isRetrying = false;
  }
}

// Process retry queue when connection is restored
ConnectionMonitor.handleOnline = function() {
  ConnectionMonitor.isOnline = true;
  ConnectionMonitor.reconnectAttempts = 0;
  ConnectionMonitor.updateConnectionStatus('online');
  ConnectionMonitor.hideConnectionBanner();
  showEnhancedToast('Connection Restored', 'You are back online', 'success', 'fas fa-wifi');
  
  // Process any queued retries
  RetryManager.processQueue();
};

</script>

<style>
/* Custom animations */
@keyframes spin {
  to { transform: rotate(360deg); }
}

.animate-spin {
  animation: spin 1s linear infinite;
}

@keyframes shake {
  0%, 100% { transform: translateX(0); }
  25% { transform: translateX(-5px); }
  75% { transform: translateX(5px); }
}

.error-shake {
  animation: shake 0.5s ease-in-out;
}

/* Smooth transitions */
* {
  transition: all 0.2s ease;
}

/* Focus states */
input:focus, select:focus, button:focus {
  outline: none;
}

/* Custom scrollbar */
::-webkit-scrollbar {
  width: 6px;
}

::-webkit-scrollbar-track {
  background: #f1f5f9;
}

::-webkit-scrollbar-thumb {
  background: #cbd5e1;
  border-radius: 3px;
}

/* Loading states */
.loading-shimmer {
  background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
  background-size: 200% 100%;
  animation: shimmer 2s infinite;
}

@keyframes shimmer {
  0% { background-position: -200% 0; }
  100% { background-position: 200% 0; }
}

/* Enhanced hover effects */
.hover-lift:hover {
  transform: translateY(-2px);
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
}

/* Connection status indicator */
.connection-pulse {
  animation: pulse 2s infinite;
}

@keyframes pulse {
  0% { opacity: 1; }
  50% { opacity: 0.5; }
  100% { opacity: 1; }
}
</style>

</body>
</html>
